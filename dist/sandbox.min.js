/*! sandbox - v1.0.1 - 2014-10-31
* https://github.com/szarouski/sandbox
 Licensed http://unlicense.org/
* Description Sandbox for scalable javascript applications
* Author Sergey Zarouski, http://webuniverse.club
*/

!function(a,b){"use strict";var c="object"!=typeof window;if("function"==typeof define&&define.amd)define(["exports","_","simple-permissions"],b);else if("object"==typeof exports)b(exports,require(c?"lodash-node":"_"),require("simple-permissions"));else{var d=a.exports||(a.exports={});b(d.sandbox={},a._,a.exports.permissions)}}(this,function(a,b,c){"use strict";function d(a,c){"string"!=typeof a&&(c=a,a=""),a=x(a,b.uniqueId("empty")),H(a,b.isString,"{String} name");var d=g(),f=i.getForSandbox(d),h=t(f,a),l=h+"/"+b.uniqueId()+"/",m=new e,n=m.checkForPrefix(h);if(n)return m.setData(c),n;j(h,a);var o=E.push(this)-1;new i({name:a,prefix:h,childrenPrefix:l,parentInfo:f,data:c}).mapToIndex(o),(new k).mapToIndex(h)}function e(){this.sandbox=null}function f(a,c){a=s(a);var d=i.getForSandbox(c),e=v(a,d);b.each(e,function(b,d){b in G||c.kid(a[d],b)})}function g(){var a=D||J||null;return D=null,a}function h(a){D=a}function i(a){var c,d=a.prefix,e=a.parentInfo;J?(c=e.prefix,this.siblingPrefixRegExp=new RegExp(e.childrenPrefix+"[^/]*$")):(c=null,this.siblingPrefixRegExp=null),this.name=a.name,this.prefix=d,this.parentPrefix=c,this.childrenPrefix=a.childrenPrefix,this.parentInfo=e,this.chindrenPrefixRegExp=new RegExp(d+".+"),this.settings=b.cloneDeep(C),this.data=a.data}function j(a,b){if(a in G)throw new o(["Siblings can't have same names. ",b," already exists."].join(""))}function k(){this.listeners=[],this.cache=[],this.permissions=[]}function l(a){this.event=a.event,this.handler=a.handler,this.binding=a.binding,this.prefix=a.prefix}function m(){this.storage={}}function n(a){this.origin=a.origin,this.type=a.type,this.data=a.data,this.invalidate=a.invalidate,this.settings=a.settings}function o(a){this.message=a}function p(a,b,c,d){var e=d===a;return e||q(c.permissions,b,a,d)}function q(a,c,d,e){var f=b.find(a,function(a){return d===a.source&&e===a.target});return!(!f||!~b.indexOf(f.permissions,c))}function r(a,c,d){b.each(a.storage,function(){var e=b.toArray(arguments);c.apply(a,e)&&d.apply(a,e)})}function s(a){return b.isArray(a)?a:[a]}function t(a,b){return J?a.childrenPrefix+b:I}function u(a,c){var d=b.map(a,function(a,b){return v(b,c)}),e=b.values(a);return b.object(d,e)}function v(a,b){var c=b.name;return a&&a!==c?w(a,b):w(c,b.parentInfo)}function w(a,c){return b.isArray(a)?b.map(a,function(a){return c.childrenPrefix+a}):[c.childrenPrefix+a]}function x(a,b){return a||b}function y(a,b){var c={};return c[a]=b,c}function z(a){return function(c){return b.all(c,a)}}function A(a){return b.isObject(a)&&b.all(a,b.isString)}e.prototype.checkForPrefix=function(a){var c=b.find(E,function(b){return b.data()===a});return c&&(this.sandbox=c),this.sandbox},e.prototype.setData=function(a){if(this.sandbox){var b=i.getForSandbox(this.sandbox);b.data=a}},d.prototype.name=function(){return i.getForSandbox(this).name},d.prototype.settings=function(a){H(a,b.isObject,"{Object} settings");var c=i.getForSandbox(this);c.settings=b.merge(c.settings,a)},d.prototype.kid=function(){h(this);var a=b.partial.apply(b,[d].concat(b.toArray(arguments)));return new a},d.prototype.data=function(){var a=i.getForSandbox(this).data;return b.isObject(a)?b.create(a):a},d.prototype.on=function(a,c,d){H(a,b.isString,"{String} eventName"),H(c,b.isFunction,"{Function} handler");var e=this,f=i.getForSandbox(e),g=f.prefix;d=x(d,e),H(d,b.isObject,"{Object} thisBinding");var h=new m;h.addByPrefixes([f.parentPrefix,[f.siblingPrefixRegExp,f.chindrenPrefixRegExp]]);var j=new l({event:a,handler:c,binding:d,prefix:g}),n=k.getForSandbox(g);return n.addListener(j),r(h,b.partial(p,g,a),b.partial(l.process,j)),e},d.prototype.off=function(a){H(a,b.isString,"{String} eventName");var c=this,d=i.getForSandbox(c),e=k.getForSandbox(d.prefix);return b.remove(e.listeners,function(b){return b.event===a}),this},d.prototype.emit=function(a,c){H(a,b.isString,"{String} eventName");var d=this,e=i.getForSandbox(d),f=new n({origin:e.prefix,type:a,data:c,invalidate:!1,settings:e.settings.cache}),g=new m;return g.addByPrefixes([e.parentPrefix,[e.siblingPrefixRegExp,e.chindrenPrefixRegExp]]),r(g,b.partial(p,e.prefix,a),b.partial(n.process,f)),d},d.prototype.trigger=d.prototype.emit;var B=function(a,c,d){2===arguments.length&&(d=c,c=a,a=void 0),H(c,z(A),"{Object.<String, String[]>} permissionsMap"),H(d,b.isFunction,"{function} updater");var e=this;f(b.keys(c).concat(a),e);var g=i.getForSandbox(e),h=new m;return h.addByPrefixes([g.prefix,g.chindrenPrefixRegExp]),h=h.getFilteredByName(g,a),c=u(c,g),m.updatePermissions(d,h.storage,c),e};d.prototype.grant=b.partialRight(B,function(a,b,d){c.grant(a.permissions,b,d)}),d.prototype.revoke=b.partialRight(B,function(a,d,e){c.revoke(a.permissions,d,e),b.remove(a.cache,function(a){return a.origin in e&&~b.indexOf(e[a.origin],a.type)})}),d.prototype.destroy=function(){var a=i.getForSandbox(this),c=k.getForSandbox(a.prefix),d=b.indexOf(E,this);E.splice(d,1),a.unMapFromIndex(d),c.unMapFromIndex(a.prefix)};var C={cache:{store:!0,expire:0,debounce:!0}};d.defaults=function(a){return a&&(H(a,b.isObject,"{Object} newDefaults"),b.merge(C,a)),C};var D=null,E=[],F=[];i.prototype.mapToIndex=function(a){F[a]=this},i.prototype.unMapFromIndex=function(a){F.splice(a,1)},i.getForSandbox=function(a){return a?F[b.indexOf(E,a)]:null};var G={};k.prototype.mapToIndex=function(a){G[a]=this},k.prototype.unMapFromIndex=function(a){G=b.omit(G,a)},k.prototype.addToCache=function(a){this.cache.push(a),a.settings.expire&&a.setupExpirationForCandidateData(this)},k.prototype.addListener=function(a){this.listeners.push(a)},k.prototype.processEvent=function(a){var b=a.filterEventListeners(this.listeners),c=a.settings.store&&!b.length;l.callEventListeners(b,a),c&&this.addToCache(a)},k.getForSandbox=function(a){return G[a]},k.getWrappedByPrefix=function(a){return y(a,k.getForSandbox(a))},k.getByRegExp=function(a){var c=s(a);return b.pick(G,function(a,d){return b.some(c,function(a){return a.test(d)})})},l.process=function(a,c){var d=this,e=d.getForSandbox(a.prefix),f=b.filter(c.cache,{type:a.event});b.each(f,b.partial(l.callEventListeners,e.listeners))},l.callEventListeners=function(a,c){b.each(a,function(a){a.handler.apply(a.binding,c.convertToArguments()),c.updateExpiration()})},m.prototype.addByPrefixes=function(a){var c=this;return b.each(a,function(a){var d;d="string"==typeof a?k.getWrappedByPrefix(a):k.getByRegExp(a),b.extend(c.storage,d)}),c},m.prototype.getForSandbox=function(a){return this.storage[a]},m.prototype.getFilteredByPrefix=function(a){return{storage:b.pick(this.storage,function(c,d){return~b.indexOf(a,d)})}},m.prototype.getFilteredByName=function(a,b){return b=v(b,a),this.getFilteredByPrefix(b)},m.updatePermissions=function(a,c,d){b.each(c,function(b,c){a(b,c,d)})},n.prototype.filterEventListeners=function(a){return b.filter(a,{event:this.type})},n.prototype.updateExpiration=function(){"function"==typeof this.invalidate&&this.invalidate()},n.prototype.setupExpirationForCandidateData=function(a){function c(){d.removeFromCache(a.cache)}var d=this,e=d.settings;e.debounce?(d.invalidate=b.debounce(c,e.expire),d.invalidate()):b.delay(c,e.expire)},n.prototype.removeFromCache=function(a){var c=b.findIndex(a,this);~c&&a.splice(c,1)},n.prototype.convertToArguments=function(){var a=s(this.data);return[this].concat(a)},n.process=function(a,b){b.processEvent(a)},o.prototype=new Error,o.prototype.constructor=o;var H=function(a,b,c){if(!b(a))throw new o(c+", received type: "+typeof a)},I="âˆš",J=new d(I);a.constructor=d,a.errorConstructor=o});